<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ“ ì„œë¥˜ ë©”ëª¨ ë³´ë“œ</title>
<style>
:root{--bg:#f5f3ef;--sidebar-bg:#eae7e0;--card-bg:#fff;--card-hover:#faf9f7;--card-active:#fff8ed;--card-active-border:#e8a94f;--accent:#d4893b;--accent-light:#f0dcc3;--text:#2c2825;--text-secondary:#7a7168;--text-light:#a89e93;--border:#ddd7ce;--danger:#c0503e;--danger-light:#f5e0dc;--success:#5a9a6e;--radius:10px;--tr:0.2s ease}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Apple SD Gothic Neo','Malgun Gothic',sans-serif;background:var(--bg);color:var(--text);height:100dvh;overflow:hidden}

/* SETUP */
.setup-screen{display:flex;align-items:center;justify-content:center;height:100dvh;padding:24px}
.setup-box{background:var(--card-bg);border-radius:16px;padding:40px;max-width:540px;width:100%;box-shadow:0 4px 16px rgba(44,40,37,.12)}
.setup-box h1{font-size:22px;font-weight:600;margin-bottom:8px}
.setup-box .sub{color:var(--text-secondary);font-size:14px;line-height:1.6;margin-bottom:24px}
.setup-box label{display:block;font-size:13px;font-weight:500;color:var(--text-secondary);margin-bottom:6px}
.setup-box input[type=text]{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;outline:none;margin-bottom:8px}
.setup-box input:focus{border-color:var(--accent)}
.setup-box .hint{font-size:12px;color:var(--text-light);margin-bottom:20px}
.sbtn{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:500;font-family:inherit;cursor:pointer}
.sbtn:hover{background:#c07830}.sbtn:disabled{background:var(--border);cursor:not-allowed}
.serr{color:var(--danger);font-size:13px;margin-top:12px;display:none}
.ssteps{background:var(--bg);border-radius:8px;padding:16px;margin-bottom:24px}
.ssteps h3{font-size:13px;font-weight:600;margin-bottom:10px}
.ssteps ol{font-size:12.5px;color:var(--text-secondary);line-height:1.9;padding-left:18px}

/* APP */
.app{display:none;height:100dvh}.app.visible{display:flex}

/* SIDEBAR */
.sidebar{width:320px;min-width:320px;background:var(--sidebar-bg);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100dvh;transition:transform .3s ease}
.sh{padding:18px 18px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.sh h1{font-size:17px;font-weight:600;display:flex;align-items:center;gap:8px}
.sa{display:flex;gap:8px;margin-top:10px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 13px;border:none;border-radius:8px;font-size:13px;font-weight:500;font-family:inherit;cursor:pointer;transition:all var(--tr)}
.bp{background:var(--accent);color:#fff}.bp:hover{background:#c07830}
.bs{background:var(--card-bg);color:var(--text-secondary);border:1px solid var(--border)}.bs:hover{background:var(--card-hover)}
.bd{background:var(--danger-light);color:var(--danger)}.bd:hover{background:#efd0cb}

.sb{margin-top:10px;position:relative}
.sb input{width:100%;padding:8px 12px 8px 30px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:var(--card-bg);color:var(--text);outline:none}
.sb input:focus{border-color:var(--accent)}.sb input::placeholder{color:var(--text-light)}
.sb .si{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text-light);font-size:13px;pointer-events:none}

.fb{display:flex;gap:5px;margin-top:9px;flex-wrap:wrap}
.fbtn{padding:4px 10px;border-radius:12px;font-size:11px;font-family:inherit;border:1px solid var(--border);background:var(--card-bg);color:var(--text-secondary);cursor:pointer}
.fbtn.on{background:var(--accent);color:#fff;border-color:var(--accent)}

.sync{display:flex;align-items:center;gap:6px;margin-top:8px;font-size:11px;color:var(--text-light)}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--success);flex-shrink:0}
.sdot.ing{background:var(--accent);animation:pu 1s infinite}.sdot.err{background:var(--danger)}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.4}}

/* CARDS */
.cl{flex:1;overflow-y:auto;padding:8px}
.cl::-webkit-scrollbar{width:4px}.cl::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.ci{display:flex;gap:9px;padding:9px 11px;border-radius:var(--radius);cursor:pointer;transition:background var(--tr);border:2px solid transparent;margin-bottom:3px;user-select:none}
.ci:hover{background:var(--card-hover)}.ci.act{background:var(--card-active);border-color:var(--card-active-border)}
.ci.dragging{opacity:.4;background:var(--accent-light)}.ci.dov{border-top:3px solid var(--accent)}
.cs{font-size:14px;cursor:pointer;flex-shrink:0;padding:2px;line-height:1;align-self:center}
.ct{width:46px;height:46px;min-width:46px;border-radius:8px;background:var(--border);overflow:hidden;display:flex;align-items:center;justify-content:center}
.ct img{width:100%;height:100%;object-fit:cover}.ct .ni{font-size:18px;color:var(--text-light)}
.cif{flex:1;min-width:0;display:flex;flex-direction:column;justify-content:center}
.cif .t{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cif .p{font-size:11px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.cif .m{display:flex;gap:5px;align-items:center;margin-top:3px;flex-wrap:wrap}
.cif .d{font-size:10px;color:var(--text-light)}
.cif .tg{font-size:10px;padding:1px 6px;border-radius:8px;background:var(--accent-light);color:var(--accent);font-weight:500}
.cif .du{font-size:10px;color:var(--text-light)}.cif .du.od{color:var(--danger);font-weight:600}.cif .du.td{color:var(--accent);font-weight:600}
.dh{cursor:grab;color:var(--text-light);font-size:15px;display:flex;align-items:center;flex-shrink:0}.dh:active{cursor:grabbing}
.el{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-light);text-align:center;padding:40px}
.el .ic{font-size:44px;margin-bottom:12px;opacity:.5}.el p{font-size:14px;line-height:1.6}

/* MAIN */
.mp{flex:1;display:flex;flex-direction:column;height:100dvh;overflow:hidden;background:var(--bg)}
.me{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-light);text-align:center;padding:40px}
.me .ic{font-size:56px;margin-bottom:16px;opacity:.4}.me p{font-size:15px;line-height:1.8}
.mc{flex:1;overflow-y:auto;padding:24px 28px;display:none}
.mc::-webkit-scrollbar{width:6px}.mc::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

.mtb{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.mst{font-size:24px;cursor:pointer;padding:2px 4px;line-height:1}
.mti{font-size:19px;font-weight:600;border:none;background:transparent;color:var(--text);font-family:inherit;flex:1;outline:none;padding:4px 0;border-bottom:2px solid transparent;min-width:0}
.mti:focus{border-bottom-color:var(--accent)}.mti::placeholder{color:var(--text-light)}

.mf{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.mfl{display:flex;align-items:center;gap:6px;font-size:13px}
.mfl label{color:var(--text-secondary);font-size:12px;font-weight:500;white-space:nowrap}
.mfl input[type=date]{padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit;color:var(--text);outline:none;background:var(--card-bg)}
.mfl select{padding:5px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit;color:var(--text);outline:none;background:var(--card-bg);cursor:pointer}
.cdub{padding:2px 6px;font-size:10px;border:1px solid var(--border);border-radius:4px;background:var(--card-bg);color:var(--text-light);cursor:pointer;font-family:inherit}.cdub:hover{color:var(--danger)}
.mdt{font-size:12px;color:var(--text-light);margin-bottom:14px}

.ia{background:var(--card-bg);border:2px dashed var(--border);border-radius:var(--radius);text-align:center;cursor:pointer;transition:all var(--tr);margin-bottom:18px;position:relative;overflow:hidden}
.ia:hover{border-color:var(--accent)}.ia.has{border-style:solid;border-color:var(--border);cursor:default}
.ia .pr{color:var(--text-light);padding:28px 20px}.ia .pr .ic{font-size:28px;margin-bottom:6px}.ia .pr p{font-size:13px}.ia .pr .s2{font-size:11px;margin-top:3px}
.ia .upl{display:none;padding:22px;color:var(--text-secondary);font-size:13px}
.ia .upl .sp{display:inline-block;width:15px;height:15px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-right:6px;vertical-align:middle}
.ia img{max-width:100%;max-height:440px;display:block;margin:0 auto;cursor:zoom-in}
.idl{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;font-size:13px;background:rgba(255,255,255,.9);color:var(--text-secondary);display:none;align-items:center;justify-content:center}
.ia:hover .idl{display:flex}.idl:hover{color:var(--danger)}
.nl{font-size:12px;font-weight:600;color:var(--text-secondary);letter-spacing:.5px;margin-bottom:8px}
.ni{width:100%;min-height:130px;padding:13px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;font-family:inherit;line-height:1.7;color:var(--text);background:var(--card-bg);resize:vertical;outline:none}
.ni:focus{border-color:var(--accent)}.ni::placeholder{color:var(--text-light)}
.mfo{display:flex;justify-content:flex-end;gap:8px;padding-top:14px;margin-top:18px;border-top:1px solid var(--border)}

.zm{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:1000;align-items:center;justify-content:center;cursor:zoom-out}
.zm.show{display:flex}.zm img{max-width:95vw;max-height:95vh;object-fit:contain}
.mh{display:none;padding:12px 16px;background:var(--sidebar-bg);border-bottom:1px solid var(--border);align-items:center;gap:12px}
.mh .bk{background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-secondary)}.mh .mt2{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.ld{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(245,243,239,.85);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px}.ld.show{display:flex}
.spn{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}.ld p{font-size:14px;color:var(--text-secondary)}
.tst{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--text);color:#fff;padding:10px 20px;border-radius:8px;font-size:13px;font-family:inherit;z-index:2000;transition:transform .3s ease;pointer-events:none}.tst.show{transform:translateX(-50%) translateY(0)}

@media(max-width:768px){
.sidebar{position:fixed;top:0;left:0;bottom:0;width:100%;min-width:unset;z-index:100}
.sidebar.hidden{transform:translateX(-100%)}
.mp{width:100%}.mh{display:flex}.mc{padding:18px 14px}.mti{font-size:17px}
.ia img{max-height:260px}.idl{display:flex}.setup-box{padding:24px}.setup-box h1{font-size:20px}
.mf{flex-direction:column;align-items:flex-start;gap:8px}.dh{display:none}
}
</style>
</head>
<body>

<div class="setup-screen" id="SS">
<div class="setup-box">
<h1>ğŸ“ ì„œë¥˜ ë©”ëª¨ ë³´ë“œ</h1>
<p class="sub">Google Sheets + Drive ì—°ê²°. PCâ†”í° ì–´ë””ì„œë“  ê°™ì€ ë©”ëª¨!</p>
<div class="ssteps"><h3>ğŸ“Œ URLë§Œ ë¶™ì—¬ë„£ìœ¼ë©´ ë</h3><ol><li>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ â†’ í™•ì¥í”„ë¡œê·¸ë¨ â†’ Apps Script</li><li>ë°°í¬ â†’ ë°°í¬ ê´€ë¦¬ â†’ URL ë³µì‚¬</li><li>ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°</li></ol></div>
<label>Apps Script ì›¹ ì•± URL</label>
<input type="text" id="urlIn" placeholder="https://script.google.com/macros/s/xxxxx/exec">
<p class="hint">ë°°í¬ í›„ ë‚˜ì˜¤ëŠ” URL ì „ì²´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
<button class="sbtn" id="sBtn" onclick="testSave()">ì—°ê²° í…ŒìŠ¤íŠ¸ & ì‹œì‘</button>
<p class="serr" id="sErr"></p>
</div></div>

<div class="app" id="app">
<div class="sidebar" id="SB">
<div class="sh">
<h1><span>ğŸ“</span> ì„œë¥˜ ë©”ëª¨ ë³´ë“œ</h1>
<div class="sa">
<button class="btn bp" onclick="createNew()">ï¼‹ ìƒˆ ë©”ëª¨</button>
<button class="btn bs" onclick="doRefresh()">â†» ìƒˆë¡œê³ ì¹¨</button>
</div>
<div class="sb"><span class="si">ğŸ”</span><input type="text" placeholder="ë©”ëª¨ ê²€ìƒ‰..." id="qIn" oninput="rl()"></div>
<div class="fb">
<button class="fbtn on" data-f="all" onclick="sf('all',this)">ì „ì²´</button>
<button class="fbtn" data-f="starred" onclick="sf('starred',this)">â­ ì¤‘ìš”</button>
<button class="fbtn" data-f="overdue" onclick="sf('overdue',this)">ğŸ”´ ë§ˆê°ì„ë°•</button>
</div>
<div class="sync"><div class="sdot" id="sDot"></div><span id="sTxt">ì—°ê²°ë¨</span><span style="margin-left:auto;cursor:pointer;text-decoration:underline;font-size:11px" onclick="resetS()">ì„¤ì •ë³€ê²½</span></div>
</div>
<div class="cl" id="CL"></div>
</div>

<div class="mp">
<div class="mh"><button class="bk" onclick="showSB()">â†</button><div class="mt2" id="mobT">ì„œë¥˜ ë©”ëª¨ ë³´ë“œ</div></div>
<div class="me" id="ME"><div class="ic">ğŸ“‹</div><p>ì™¼ìª½ì—ì„œ ë©”ëª¨ë¥¼ ì„ íƒí•˜ê±°ë‚˜<br><b>ìƒˆ ë©”ëª¨</b>ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p></div>
<div class="mc" id="MC">
<div class="mtb"><span class="mst" id="mStar" onclick="tgStar()">â˜†</span><input type="text" class="mti" id="tIn" placeholder="ì œëª© (ì˜ˆ: ì•„ë™ëª…ë¶€ ì œì¶œ ì•ˆë‚´)" oninput="aSave()"></div>
<div class="mf">
<div class="mfl"><label>ğŸ“… ë§ˆê°ì¼</label><input type="date" id="duIn" onchange="aSave()"><button class="cdub" onclick="document.getElementById('duIn').value='';aSave()">âœ•</button></div>
<div class="mfl"><label>ğŸ·ï¸ ë¶„ë¥˜</label><select id="catSel" onchange="aSave()"><option value="">ì—†ìŒ</option><option value="ì—…ë¬´">ì—…ë¬´</option><option value="í–‰ì‚¬">í–‰ì‚¬</option><option value="ì˜ˆì‚°">ì˜ˆì‚°</option><option value="ì œì¶œ">ì œì¶œ</option><option value="íšŒì˜">íšŒì˜</option><option value="ê¸°íƒ€">ê¸°íƒ€</option></select></div>
</div>
<div class="mdt" id="mDt"></div>
<div class="ia" id="IA" onclick="trgUp()">
<div class="pr" id="iPr"><div class="ic">ğŸ“·</div><p>í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</p><p class="s2">ì´¬ì˜ ë˜ëŠ” ì•¨ë²”ì—ì„œ ì„ íƒ</p></div>
<div class="upl" id="iUpl"><span class="sp"></span>Driveì— ì—…ë¡œë“œ ì¤‘...</div>
<button class="idl" id="iDel" onclick="event.stopPropagation();rmImg()">âœ•</button>
</div>
<input type="file" id="fIn" accept="image/*" style="display:none" onchange="hFile(event)">
<div class="nl">ğŸ“ ë©”ëª¨</div>
<textarea class="ni" id="nIn" placeholder="ì´ ì„œë¥˜ê°€ ë­”ì§€, ë­˜ í•´ì•¼ í•˜ëŠ”ì§€ ê°„ë‹¨íˆ..." oninput="aSave()"></textarea>
<div class="mfo"><button class="btn bd" onclick="delMemo()">ğŸ—‘ ì‚­ì œ</button></div>
</div>
</div>
</div>

<div class="zm" id="ZM" onclick="this.classList.remove('show')"><img id="zmI"></div>
<div class="ld" id="LD"><div class="spn"></div><p id="ldT">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
<div class="tst" id="TST"></div>

<script>
var U='',M=[],AID=null,ST=null,CF='all',DSI=null;

function checkS(){var u=localStorage.getItem('mb-url');if(u){U=u;$('SS').style.display='none';$('app').classList.add('visible');doRefresh();}}
function testSave(){
  var url=$('urlIn').value.trim(),e=$('sErr'),b=$('sBtn');
  if(!url||url.indexOf('https://script.google.com/')<0){e.textContent='Google Apps Script URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';e.style.display='block';return;}
  b.disabled=true;b.textContent='ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';e.style.display='none';
  fetch(url+'?action=list').then(r=>r.json()).then(d=>{
    if(d.success){U=url;localStorage.setItem('mb-url',url);$('SS').style.display='none';$('app').classList.add('visible');M=d.memos||[];pa();rl();toast('âœ… ì—°ê²° ì„±ê³µ!');}
    else throw new Error(d.error);
  }).catch(x=>{e.textContent='ì—°ê²° ì‹¤íŒ¨: '+x.message;e.style.display='block';}).finally(()=>{b.disabled=false;b.textContent='ì—°ê²° í…ŒìŠ¤íŠ¸ & ì‹œì‘';});
}
function resetS(){if(!confirm('ì„¤ì • ì´ˆê¸°í™”?'))return;localStorage.removeItem('mb-url');location.reload();}

function api(a,p,body){
  var url=U+'?action='+a;if(p)url+=p;
  var o={};if(body){o.method='POST';o.headers={'Content-Type':'text/plain'};o.body=JSON.stringify(body);}
  return fetch(url,o).then(r=>r.json());
}

function pa(){M.forEach(m=>{
  if(m.image&&typeof m.image==='string'&&m.image.charAt(0)==='{'){try{m._i=JSON.parse(m.image);}catch(e){m._i=null;}}else m._i=null;
  m.x=px(m);
});}
function px(m){var n=m.note||'';if(n.indexOf('$$M:')===0){var nl=n.indexOf('\n'),s=nl>=0?n.substring(4,nl):n.substring(4);try{var o=JSON.parse(s);if(!o.o)o.o=0;return o;}catch(e){}}return{s:false,d:'',c:'',o:0};}
function gnt(m){var n=m.note||'';if(n.indexOf('$$M:')===0){var nl=n.indexOf('\n');return nl>=0?n.substring(nl+1):'';}return n;}
function bn(m,t){return'$$M:'+JSON.stringify(m.x)+'\n'+t;}
function iu(m){return m._i&&m._i.imageUrl?m._i.imageUrl:null;}

function sf(f,el){CF=f;document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));el.classList.add('on');rl();}

function createNew(){
  var m={id:Date.now().toString(),title:'',note:'',image:'',_i:null,x:{s:false,d:'',c:'',o:Date.now()},created:new Date().toISOString(),updated:new Date().toISOString()};
  m.note=bn(m,'');M.unshift(m);rl();sel(m.id);
  api('save',null,{id:m.id,title:m.title,note:m.note,image:m.image,created:m.created,updated:m.updated});
  if(window.innerWidth<=768)$('SB').classList.add('hidden');
}

function sel(id){
  AID=id;var m=M.find(x=>x.id===id);if(!m)return;
  $('ME').style.display='none';$('MC').style.display='block';
  $('tIn').value=m.title;$('nIn').value=gnt(m);$('duIn').value=m.x.d||'';$('catSel').value=m.x.c||'';
  $('mStar').textContent=m.x.s?'â˜…':'â˜†';$('mStar').style.color=m.x.s?'#e8a94f':'var(--text-light)';
  $('mDt').textContent=fd(m.created)+(m.updated!==m.created?' (ìˆ˜ì •:'+fd(m.updated)+')':'');
  $('mobT').textContent=m.title||'ìƒˆ ë©”ëª¨';
  var a=$('IA'),pr=$('iPr'),dl=$('iDel'),up=$('iUpl');up.style.display='none';
  var url=iu(m),ex=a.querySelector('img');
  if(url){a.classList.add('has');pr.style.display='none';dl.style.display='flex';if(!ex){ex=document.createElement('img');a.appendChild(ex);}ex.src=url;ex.onclick=e=>{e.stopPropagation();$('zmI').src=url;$('ZM').classList.add('show');};}
  else{a.classList.remove('has');pr.style.display='block';dl.style.display='none';if(ex)ex.remove();}
  rl();if(!m.title)setTimeout(()=>$('tIn').focus(),100);
}

function tgStar(){if(!AID)return;var m=M.find(x=>x.id===AID);if(!m)return;m.x.s=!m.x.s;$('mStar').textContent=m.x.s?'â˜…':'â˜†';$('mStar').style.color=m.x.s?'#e8a94f':'var(--text-light)';ds(m);}
function tgSI(id){var m=M.find(x=>x.id===id);if(!m)return;m.x.s=!m.x.s;ds(m);if(AID===id){$('mStar').textContent=m.x.s?'â˜…':'â˜†';$('mStar').style.color=m.x.s?'#e8a94f':'var(--text-light)';}}

function aSave(){
  if(!AID)return;var m=M.find(x=>x.id===AID);if(!m)return;
  m.title=$('tIn').value;m.x.d=$('duIn').value;m.x.c=$('catSel').value;
  m.note=bn(m,$('nIn').value);m.updated=new Date().toISOString();$('mobT').textContent=m.title||'ìƒˆ ë©”ëª¨';
  clearTimeout(ST);ST=setTimeout(()=>ds(m),1500);
}
function ds(m){m.note=bn(m,gnt(m));m.updated=new Date().toISOString();rl();ss('ing','ì €ì¥ ì¤‘...');
  api('save',null,{id:m.id,title:m.title,note:m.note,image:m.image,created:m.created,updated:m.updated}).then(d=>{if(d.success)ss('ok','ì €ì¥ë¨ Â· '+tn());else ss('err','ì €ì¥ ì‹¤íŒ¨');}).catch(()=>ss('err','ì €ì¥ ì‹¤íŒ¨'));}

function trgUp(){var m=M.find(x=>x.id===AID);if(m&&iu(m))return;$('fIn').click();}
function hFile(ev){
  var f=ev.target.files[0];if(!f||!AID)return;
  $('iPr').style.display='none';$('iUpl').style.display='block';
  var r=new FileReader();r.onload=e=>{var img=new Image();img.onload=()=>{
    var c=document.createElement('canvas'),mx=1000,w=img.width,h=img.height;
    if(w>mx){h=h*mx/w;w=mx;}if(h>mx){w=w*mx/h;h=mx;}c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
    var b=c.toDataURL('image/jpeg',.6).split(',')[1];
    api('upload',null,{id:AID,imageData:b,mimeType:'image/jpeg'}).then(d=>{
      if(d.success){var m=M.find(x=>x.id===AID);if(m){m.image=JSON.stringify({fileId:d.fileId,imageUrl:d.imageUrl});m._i={fileId:d.fileId,imageUrl:d.imageUrl};m.updated=new Date().toISOString();api('save',null,{id:m.id,title:m.title,note:m.note,image:m.image,created:m.created,updated:m.updated});sel(AID);rl();toast('ğŸ“· ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ');}}
      else{$('iUpl').style.display='none';$('iPr').style.display='block';toast('âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨');}
    }).catch(()=>{$('iUpl').style.display='none';$('iPr').style.display='block';toast('âš ï¸ ì—…ë¡œë“œ ì‹¤íŒ¨');});
  };img.src=e.target.result;};r.readAsDataURL(f);ev.target.value='';
}
function rmImg(){if(!AID||!confirm('ì´ë¯¸ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?'))return;var m=M.find(x=>x.id===AID);if(!m)return;if(m._i&&m._i.fileId)api('deleteImage','&fileId='+m._i.fileId);m.image='';m._i=null;ds(m);sel(AID);rl();}

function delMemo(){if(!AID)return;var m=M.find(x=>x.id===AID);if(!confirm('"'+(m?m.title||'ì œëª© ì—†ìŒ':'')+'" ì‚­ì œ?'))return;var id=AID;M=M.filter(x=>x.id!==id);AID=null;rl();$('ME').style.display='flex';$('MC').style.display='none';api('delete','&id='+id);toast('ì‚­ì œë¨');if(window.innerWidth<=768)showSB();}

function doRefresh(){sl('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');api('list').then(d=>{if(d.success){M=d.memos||[];pa();rl();ss('ok','ë™ê¸°í™” Â· '+tn());}if(AID){var m=M.find(x=>x.id===AID);if(m)sel(AID);}hl();}).catch(()=>{ss('err','ì—°ê²° ì‹¤íŒ¨');hl();});}

function rl(){
  var list=$('CL'),q=$('qIn').value.toLowerCase().trim(),f=gf(q),today=new Date().toISOString().slice(0,10);
  if(!f.length){list.innerHTML='<div class="el"><div class="ic">'+(q?'ğŸ”':'ğŸ“')+'</div><p>'+(q?'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ':CF!=='all'?'í•´ë‹¹ ë©”ëª¨ ì—†ìŒ':'ì•„ì§ ë©”ëª¨ê°€ ì—†ì–´ìš”.<br><b>ìƒˆ ë©”ëª¨</b>ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!')+'</p></div>';return;}
  list.innerHTML=f.map((m,i)=>{
    var u=iu(m),dH='',cH='';
    if(m.x&&m.x.d){var cls='du';if(m.x.d<today)cls+=' od';else if(m.x.d===today)cls+=' td';dH='<span class="'+cls+'">ğŸ“…'+m.x.d.slice(5)+'</span>';}
    if(m.x&&m.x.c)cH='<span class="tg">'+esc(m.x.c)+'</span>';
    var sT=m.x&&m.x.s?'â˜…':'â˜†',sC=m.x&&m.x.s?'color:#e8a94f':'color:var(--text-light)';
    return'<div class="ci'+(m.id===AID?' act':'')+'" data-id="'+m.id+'" data-idx="'+i+'" draggable="true">'
    +'<span class="dh">â ¿</span>'
    +'<span class="cs" style="'+sC+'" onclick="event.stopPropagation();tgSI(\''+m.id+'\')">'+sT+'</span>'
    +'<div class="ct" onclick="sel(\''+m.id+'\');hm()">'+(u?'<img src="'+u+'">':'<span class="ni">ğŸ“„</span>')+'</div>'
    +'<div class="cif" onclick="sel(\''+m.id+'\');hm()"><div class="t">'+esc(m.title||'ì œëª© ì—†ìŒ')+'</div>'
    +'<div class="p">'+esc(gnt(m)?gnt(m).substring(0,40):'ë©”ëª¨ ì—†ìŒ')+'</div>'
    +'<div class="m">'+cH+dH+'<span class="d">'+fs(m.updated||m.created)+'</span></div></div></div>';
  }).join('');
  ade();
}
function gf(q){
  var f=M.slice(),today=new Date().toISOString().slice(0,10);
  if(CF==='starred')f=f.filter(m=>m.x&&m.x.s);
  if(CF==='overdue')f=f.filter(m=>m.x&&m.x.d&&m.x.d<=today);
  if(q)f=f.filter(m=>(m.title&&m.title.toLowerCase().indexOf(q)>=0)||(gnt(m).toLowerCase().indexOf(q)>=0)||(m.x&&m.x.c&&m.x.c.indexOf(q)>=0));
  f.sort((a,b)=>{var oa=a.x?a.x.o:0,ob=b.x?b.x.o:0;if(oa&&ob)return oa-ob;return new Date(b.updated||b.created)-new Date(a.updated||a.created);});
  return f;
}

function ade(){
  $('CL').querySelectorAll('.ci').forEach(el=>{
    el.addEventListener('dragstart',e=>{DSI=parseInt(el.dataset.idx);el.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
    el.addEventListener('dragend',()=>{el.classList.remove('dragging');document.querySelectorAll('.ci').forEach(c=>c.classList.remove('dov'));});
    el.addEventListener('dragover',e=>{e.preventDefault();document.querySelectorAll('.ci').forEach(c=>c.classList.remove('dov'));el.classList.add('dov');});
    el.addEventListener('dragleave',()=>el.classList.remove('dov'));
    el.addEventListener('drop',e=>{e.preventDefault();el.classList.remove('dov');var ti=parseInt(el.dataset.idx);if(DSI!==null&&DSI!==ti)reord(DSI,ti);DSI=null;});
  });
}
function reord(from,to){
  var f=gf($('qIn').value.toLowerCase().trim());
  if(from<0||from>=f.length||to<0||to>=f.length)return;
  var item=f.splice(from,1)[0];f.splice(to,0,item);
  for(var i=0;i<f.length;i++){f[i].x.o=i+1;f[i].note=bn(f[i],gnt(f[i]));}
  rl();f.forEach(m=>api('save',null,{id:m.id,title:m.title,note:m.note,image:m.image,created:m.created,updated:m.updated}));
  ss('ok','ìˆœì„œ ë³€ê²½ë¨');
}

function showSB(){$('SB').classList.remove('hidden');}
function hm(){if(window.innerWidth<=768)$('SB').classList.add('hidden');}

function ss(s,t){$('sDot').className='sdot'+(s==='ing'?' ing':s==='err'?' err':'');$('sTxt').textContent=t;}
function sl(t){$('ldT').textContent=t;$('LD').classList.add('show');}function hl(){$('LD').classList.remove('show');}
function toast(m){var t=$('TST');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function fd(iso){if(!iso)return'';var d=new Date(iso),w=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];return(d.getMonth()+1)+'/'+d.getDate()+'('+w[d.getDay()]+') '+d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');}
function fs(iso){if(!iso)return'';var d=new Date(iso),df=Date.now()-d;if(df<6e4)return'ë°©ê¸ˆ';if(df<36e5)return Math.floor(df/6e4)+'ë¶„ ì „';if(df<864e5)return Math.floor(df/36e5)+'ì‹œê°„ ì „';if(df<6048e5)return Math.floor(df/864e5)+'ì¼ ì „';return(d.getMonth()+1)+'/'+d.getDate();}
function tn(){var d=new Date();return d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');}
function esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function $(id){return document.getElementById(id);}

document.addEventListener('keydown',e=>{if(e.key==='Escape')$('ZM').classList.remove('show');});

var ia=$('IA');
ia.addEventListener('dragover',e=>{e.preventDefault();e.stopPropagation();ia.style.borderColor='var(--accent)';});
ia.addEventListener('dragleave',e=>{e.stopPropagation();ia.style.borderColor='';});
ia.addEventListener('drop',e=>{e.preventDefault();e.stopPropagation();ia.style.borderColor='';var f=e.dataTransfer.files[0];if(f&&f.type.indexOf('image/')===0)hFile({target:{files:[f],value:''}});});

checkS();
</script>
</body>
</html>
